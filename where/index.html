<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <style data="test"></style>
    <script>
        let where; //drawing canvas mousedown location
        let a; //left
        let b; //right
        let Wy; //y location
        let Wx = []; //x location
        let bracket = ""; //on bracket text
        let Fun = null; // full function

        let canvas; //drawing canvas
        let ctx; //drawing canvas.ctx
        window.onload = () => {
            canvas = document.getElementById('canvas'); //canvas
            ctx = canvas.getContext('2d'); //canvas.getContext
            canvas.style.left = (window.innerWidth - canvas.width) / 2 + 'px'; //center
            canvas.style.top = (window.innerHeight - canvas.height) / 2 + 'px'; //center
            /* setColor */
            let color_canvas = document.getElementById("Choice_color"); //bar
            let color_ctx = color_canvas.getContext("2d"); //barctx
            let cc = document.getElementById('Choice_bw'); //b,w
            let ct = cc.getContext('2d'); //b,w ctx
            let thumb = document.getElementById('thumb'); //thumb
            let tcx; //click x
            let tmx; //move x
            let tp = false; //press
            let tl; //left
            let Box= document.getElementById("Color_box");
            let lx="254.0";
            let ly="0.0";
            let bw= document.getElementById("bw");
            let bcx;let bmx;let bl;let bp=false;
            let bcy;let bmy;let bt;
            const _Color = () => {
                var grd = color_ctx.createLinearGradient(0, 0, 255, 0);
                grd.addColorStop(0.1, "hsl(0,100%,50%)");
                grd.addColorStop(1 / 6, "hsl(60,100%,50%)");
                grd.addColorStop(2 / 6, "hsl(120,100%,50%)");
                grd.addColorStop(3 / 6, "hsl(180,100%,50%)");
                grd.addColorStop(4 / 6, "hsl(240,100%,50%)");
                grd.addColorStop(5 / 6, "hsl(300,100%,50%)");
                grd.addColorStop(0.9, "hsl(360,100%,50%)");
                color_ctx.fillStyle = grd;
                color_ctx.fillRect(0, 0, 255, 15);
            }; //background gradient//background gradient
            _Color(); //background gradient

            const _ClickBar = (e,target) => { //color_canvas 클릭시
                let rect = target.getBoundingClientRect();
                if(target.id=="Choice_color"){
                    let x = (e.clientX - rect.left + 6);
                    _Move(x, thumb, 6, 254);
                }else{
                    let x = (e.clientX - rect.left + 9);
                    let y = (e.clientY - rect.top +37);
                    _Move(x, bw, 9, 261, y);
                }
                if (e.target.id == "Choice_color") {
                    let rect = color_canvas.getBoundingClientRect();
                    let x = (e.clientX - rect.left);
                    let y = (e.clientY - rect.top);
                    let get_rgb = color_ctx.getImageData(x, y, 1, 1).data; //get rgb_code
                    _ApplyColor(get_rgb);
                }
            };
            const _FColor= (x,y) =>{//아래꺼 thumb움직일때마다
                console.log(`${x},${y}`);
                let rgb = ct.getImageData(x, y, 1, 1).data;
                let g1= rgb[0];
                let g2= rgb[1];
                let g3= rgb[2];
                Box.style.background= `rgb(${g1},${g2},${g3})`; //stroke
                ctx.strokeStyle = `rgb(${g1},${g2},${g3})`; //stroke
            }
            const _ApplyColor = (g) => {//위에꺼 thumb움직일때마다
                /* box fill */
                thumb.style.background = `rgb(${g[0]},${g[1]},${g[2]})`; //thumb
                for (var i = 0; i <= 255; i++) {
                    var grd = color_ctx.createLinearGradient(0, 0, 0, 255);
                    let g1=255-((255-g[0])/255*i);
                    let g2=255-((255-g[1])/255*i);
                    let g3=255-((255-g[2])/255*i);
                    grd.addColorStop(0.0,`rgb(${g1},${g2},${g3})`);
                    grd.addColorStop(0.1,`rgb(${g1},${g2},${g3})`);
                    grd.addColorStop(0.9, "rgb(0,0,0)");
                    ct.fillStyle=grd;
                    ct.fillRect(i, 0, i + 1, 255);
                }
                _FColor(lx,ly);
                /* //box fill */
            } //apply color
            const _Move = (x,t, min, max, y=false) => {//move thumb
                if(y!=false){
                    if(291 < y) {
                        t.style.top = "291px";
                    } else if(y < 37) {
                        t.style.top = "37px";
                    } else {
                        t.style.top = y + "px";
                    }
                }
                if (max < x) {
                    t.style.left = max + "px";
                } else if (x < min) {
                    t.style.left = min + "px";
                } else {
                    t.style.left = x + "px";
                }
            }
            const _ApplyBw= (rgb) =>{
                Box.style.background= `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
            };
            _ApplyColor(color_ctx.getImageData(0, 1, 1, 1).data);

            color_canvas.addEventListener("mousedown", (e) => {//bar click
                _ClickBar(e,color_canvas);
                tcx = e.clientX;
                tl = parseInt(thumb.style.left, 10);
                tp = true;
            }); //bar click
            thumb.addEventListener("mousedown", (e) => {//thumb click
                tcx = (e.clientX);
                tl = parseInt(thumb.style.left, 10);
                tp = true;
            }); //thumb click

            cc.addEventListener("mousedown", (e) =>{
                _ClickBar(e,cc);
                bcx = (e.clientX);
                bl = parseInt(bw.style.left, 10);
                bcy = (e.clientY);
                bt = parseInt(bw.style.top, 10);
                bp = true;
            });//명도 채도조절박스
            bw.addEventListener("mousedown", (e) =>{
                bcx = (e.clientX);
                bl = parseInt(bw.style.left, 10);
                bcy = (e.clientY);
                bt = parseInt(bw.style.top, 10);
                bp = true;
            });//명도 채도조절thumb
            window.addEventListener("mousemove", (e) => { //click->move
                if (tp) {//위에꺼
                    let rect = thumb.getBoundingClientRect();
                    tmx = (e.clientX);
                    let x = tmx - tcx + tl;
                    _Move(x, thumb, 6, 254);
                    let gx = ((parseInt(thumb.style.left, 10) - 6) * (255 / 249)).toFixed(1); //get x
                    let get_rgb = color_ctx.getImageData(gx, 1, 1, 1).data; //get x.colordata
                    _ApplyColor(get_rgb);
                }
                if (bp) {//아래꺼
                    let rect = bw.getBoundingClientRect();
                    bmx = (e.clientX);
                    bmy = (e.clientY);
                    let x = bmx - bcx + bl;
                    let y = bmy - bcy + bt;
                    _Move(x, bw, 9, 261, y);
                    let gx = ((parseInt(bw.style.left, 10) - 9) * (254 / 252)).toFixed(1); //get x 9~216 252*x=255
                    let gy = ((parseInt(bw.style.top, 10) - 37) * (254 / 255)).toFixed(1); //get x 37~291
                    _FColor(gx, gy);
                }
            });
            window.addEventListener("mouseup", (e) => {
                if (tp)//위에꺼
                    tp = !tp;
                if (bp){//아래꺼
                    bp = !bp;
                    lx = ((parseInt(bw.style.left, 10) - 9) * (254 / 252)).toFixed(1); //get x 9~216 252*x=255
                    ly = ((parseInt(bw.style.top, 10) - 37) * (254 / 255)).toFixed(1); //get x 37~291
                }
            }); //click->move->up
            /* //setColor */
            /* drawing */
            let press = false; //drawing canvas mousedown
            let dx; //drawing canvas mousedown x
            let dy; //drawing canvas mousedown y
            let mx; //drawing canvas mousemove x
            let my; //drawing canvas mousemove x
            where = document.getElementById("where"); //위치표시박스
            const _Where = (e) => { //위치표시박스에 위치넣어줌
                where.style.left = (e.pageX + 30) + "px";
                where.style.top = (e.pageY - 30) + "px";
                where.innerText = `(${dx-canvas.width/2}, ${canvas.height/2-dy})`;
            }
            const getW = (e, w) => { //get x,y location
                return w ? (e.pageX - parseInt(canvas.style.left, 10)) : (e.pageY - parseInt(canvas.style
                    .top, 10));
            }
            canvas.addEventListener("mousedown", (e) => {
                ctx.beginPath();
                dx = getW(e, true); //getx
                dy = getW(e, false); //gety
                press = true; //누르는중
                ctx.moveTo(dx, dy);
                ctx.lineTo(dx, dy);
                ctx.stroke();
                _Where(e); //위치표시
            });
            window.addEventListener("mousemove", (e) => {
                if (press) {
                    mx = getW(e, true);
                    my = getW(e, false);
                    ctx.moveTo(dx, dy);
                    ctx.lineTo(mx, my);
                    ctx.stroke();
                    dx = mx;
                    dy = my;
                    e.target.id == 'canvas' ?
                        _Where(e) :
                        where.innerText = "";
                }
            });
            window.addEventListener("mouseup", (e) => {
                press = false;
                where.innerText = "";
                ctx.closePath();
            });
            /* //drawing */
            /* function and draw */
            const _Grid = () => { //격자 라인
                ctx.lineCap = "round";
                ctx.strokeStyle = "#333";
                ctx.beginPath();
                ctx.moveTo(0, canvas.width / 2);
                ctx.lineTo(canvas.height, canvas.width / 2);
                ctx.stroke();
                ctx.moveTo(canvas.height / 2, 0);
                ctx.lineTo(canvas.height / 2, canvas.width);
                ctx.stroke();
                ctx.closePath();
                ctx.beginPath();
            }
            _Grid(); //격자
            const _Checking = (v) => {
                switch (v) {
                    case "1":
                    case "2":
                    case "3":
                    case "4":
                    case "5":
                    case "6":
                    case "7":
                    case "8":
                    case "9":
                    case "0":
                    case "+":
                    case "-":
                    case "*":
                    case "/":
                    case "^":
                    case ")":
                    case "(":
                    case "x":
                    case "y":
                    case "=":
                        return true;
                        break;
                    default:
                        console.log(v);
                        return false
                }
            }
            let form = document.getElementById("get_f"); //form
            form.addEventListener("submit", (e) => { //submit
                e.preventDefault();
                Fun = document.getElementById("Function").value; //Fun에 input 값 넣어줌
                document.getElementById("Function").value = ""; //input reset
                Fun.split("").map(v => {
                    if (!_Checking(v)) {
                        Fun = ""
                    }
                });
                if (Fun == "") {
                    alert("안돼요");
                    return false;
                } //empty input
                a = Fun.split("=")[0].split(""); //left
                b = Fun.split("=")[1].split(""); //right
                const _GetXY = (t, w) => { //return x,y location
                    let arr = [];
                    t.map((v, e) => {
                        v == w ? arr[e] = e : "";
                    });
                    return arr;
                };
                Wx = _GetXY(b, 'x'); //x location
                Wy = _GetXY(a, 'y'); //y locaion
                let evr = ""; //eval
                let m = undefined; //minus

                ctx.beginPath(); //start;
                for (var i = -4; i <= 4; i = i + 0.01) { //-4~4 line draw
                    _Line(Wx, b, i, true); //move
                    _Line(Wx, b, i + 0.01, false); //line
                }
                ctx.closePath(); //end
            });
            const _InsetX = (WX, B, i) => {
                WX.map((v, e) => { //Wx에 넣어둔 x위치에 i값을 넣어줌
                    if (!isNaN(Number(B[WX[e] - 1])))
                        B[WX[e]] = "*" + i; //넣어줌
                    else
                        B[WX[e]] = '(' + i + ')'; //넣어줌
                });
            };
            const _Line = (WX, B, i, tf) => {
                let onbracket = false; //default: false
                bracket = ""; //괄호속 내용
                _InsetX(WX, B, i); //b의 X위치에 값넣어줌
                let Lb = B.slice(); //b는 그대로두고 b속의 값만 가져옴
                Lb.map((v, n) => {
                    switch (Lb[n]) {
                        case '(':
                            while (Lb[n] != ')') {
                                if (Lb[n] == '^')
                                    bracket += '**';
                                else
                                    bracket += Lb[n];
                                n++;
                            }
                            bracket += Lb[n];
                            n++;
                            break;
                        case '^':
                            let sq = "";
                            for (var i = 0; i < Lb[n + 1] - 1; i++) {
                                sq += "*" + Lb[n - 1];
                            }
                            Lb[n] = sq;
                            Lb[n + 1] = "";
                            break;
                        default:
                    }
                });
                evr = "";
                m = undefined;
                for (var j = 0; j < Lb.length; j++) { //evr에 넣어줌
                    if (onbracket) {
                        if (Lb[j] == ')')
                            onbracket = false;
                    } else {
                        if (m != undefined) { //j-1 == "-"
                            if (Lb[j] != '(') {
                                if (Lb[j - 1] != undefined)
                                    evr += "-" + Lb[j];
                                else
                                    evr += "-" + Lb[j];
                            } else if (Lb[j + 1] == '^') {
                                evr += '(' + Lb[j];
                                j++;
                                for (var p = 1; p < Lb[j + 1]; p++) {
                                    evr += "*" + Lb[j - 1];
                                }
                                evr += ')';
                                j++;
                            } else if (Lb[j] == '(') {
                                onbracket = true;
                                evr += "(-1)*" + bracket;
                            } else {
                                if (Lb[j - 1] != undefined)
                                    evr += "-" + B[j];
                                else
                                    evr += "-" + B[j];
                            }
                            m = undefined;
                        } else {
                            if (Lb[j] == '-') { // j == "-"
                                if (m == undefined) { // m값이 없으면 m == j
                                    m = j;
                                }
                            } else if (Lb[j + 1] == '^') {
                                evr += '(' + Lb[j];
                                j++;
                                for (var p = 1; p < Lb[j + 1]; p++) {
                                    evr += "*" + Lb[j - 1];
                                }
                                evr += ')';
                                j++;
                            } else { // j != "-"
                                if (Lb[j] == '(') {
                                    onbracket = true;
                                    evr += bracket;
                                } else {
                                    evr += Lb[j];
                                }
                            }
                        }
                    }
                }
                let xl = ((i * 100) + 400).toFixed(2); //x location
                let yl = ((-(eval(evr) * 100)) + 400).toFixed(2); //y location
                if (810 >= yl && yl >= -10) //in canvas
                    tf ? ctx.moveTo(xl, yl) : (ctx.lineTo(xl, yl), ctx.stroke());
            }
            /* //function and draw */
            /* ex) function */
            ctx.strokeStyle = "#ff0000";
            document.getElementById('Function').value = 'y=x^3-x^2-x+1';
            document.getElementsByTagName('button')[0].click();
            ctx.strokeStyle = "#00ffff";
            document.getElementById('Function').value = 'y=x^2';
            document.getElementsByTagName('button')[0].click();
            ctx.strokeStyle = "#ff0000";
            /* //ex) function */
        }
    </script>
    <title>Where</title>
</head>

<body>
    <canvas id="canvas" width="800" height="800">turn on js</canvas>
    <form id="get_f" action="" method="">
        <input id="Function" type="text" placeholder="y=x^2" autofocus/>
        <button type="submit">입력</button>
        <br>
        <div id="Color_box"></div>
        setColor
    </form>
    <span id="where"></span>
    <div id="Color_set">
        <canvas id="Choice_color" width="255" height="15">
        </canvas>
        <span id="thumb" style="left: 6px;background: red;"></span>
        <canvas id="Choice_bw" width="255" height="255">
        </canvas>
        <span id="bw" style="left: 261px;top: 37px;background: rgba(255,255,255, 0.3);"></span>
    </div>
</body>

</html>
