<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="./style.css">
  <style data="test"></style>
  <script>
    let canvas;
    let ctx;

    let where;

    let a;
    let b;
    let Wy;
    let Wx= [];
    let bracket= "";
    let Fun=null;

    let color_canvas;
    let color_ctx;
    let style;
    window.onload = () => {
      style = document.querySelector('[data="test"]');
      //setColor
      let Box= document.getElementById("Color_box");
      Box.addEventListener("click",() =>{
        document.querySelector("#Color_set").style.display= "block";
      }, false);

      color_canvas= document.getElementById("Choice_color");
      color_ctx=color_canvas.getContext("2d");

      let color_press= false;
      const _Color= () =>{
        var grd = color_ctx.createLinearGradient(0, 0, 255, 0);
        grd.addColorStop(0, "rgb(255, 0, 0)");
        grd.addColorStop(1 / 6, "rgb(255, 255, 0)");
        grd.addColorStop(2 / 6, "rgb(0, 255, 0)");
        grd.addColorStop(3 / 6, "rgb(0, 255, 255)");
        grd.addColorStop(4 / 6, "rgb(0, 0, 255)");
        grd.addColorStop(5 / 6, "rgb(255, 0, 255)");
        grd.addColorStop(1, "rgb(255, 0, 0)");
        color_ctx.fillStyle = grd;
        color_ctx.fillRect(0, 0, 255, 25);
      };
      _Color();
      const _SetRangeColor= (GR) =>{
        style.innerHTML += `input[type=range]::-webkit-slider-thumb { background: rgb(${GR[0]}, ${GR[1]}, ${GR[2]}); }`;
      }
      const _SetColor= (e) =>{
        if(e.target.id == "Choice_color") {
          let rect = color_canvas.getBoundingClientRect();
          let x= ( e.clientX - rect.left );
          let y= ( e.clientY - rect.top );
          let get_rgb= color_ctx.getImageData(x, y, 1, 1).data;
          _SetRangeColor(get_rgb);
          Box.style.background= `rgb(${get_rgb[0]},${get_rgb[1]},${get_rgb[2]}`;
          ctx.strokeStyle= `rgb(${get_rgb[0]},${get_rgb[1]},${get_rgb[2]})`;
          console.log(`rgb(${get_rgb[0]},${get_rgb[1]},${get_rgb[2]})`);
        }
      };
      color_canvas.addEventListener("mousedown", (e) =>{
        _SetColor(e);
        color_press= true;
      });
      window.addEventListener("mousemove", (e) =>{
        if(color_press)
          _SetColor(e);
      });
      window.addEventListener("mouseup", (e) =>{
        if(color_press){
          _SetColor(e);
          color_press=false;
        }
      });






      //function and draw
      canvas = document.getElementById('canvas'); //canvas
      canvas.style.left = (window.innerWidth - canvas.width) / 2 + 'px';
      canvas.style.top = (window.innerHeight - canvas.height) / 2 + 'px';
      ctx = canvas.getContext('2d'); //canvas.getContext
      const _Grid = () => {
        ctx.lineCap = "round";
        ctx.strokeStyle="#333";
        ctx.beginPath();
        ctx.moveTo(0, canvas.width / 2);
        ctx.lineTo(canvas.height, canvas.width / 2);
        ctx.stroke();
        ctx.moveTo(canvas.height / 2, 0);
        ctx.lineTo(canvas.height / 2, canvas.width);
        ctx.stroke();
        ctx.closePath();
        ctx.beginPath();
      }
      _Grid();//격자
      ctx.strokeStyle = "#000";
      document.getElementById("get_f").addEventListener("submit", (e) => {
        e.preventDefault();
        Fun = document.getElementById("Function").value;//Fun에 input 값 넣어줌
        if(Fun=="")
          return false;
        document.getElementById("Function").value = "";//input reset
        a = Fun.split("=")[0].split("");//등호 왼쪽
        b = Fun.split("=")[1].split("");//등호 오른쪽
        Wx=[];//x location
        Wy=0;//y locaion
        let evr="";//eval
        let m=undefined;//minus
        a.map((v, e) =>{
          v=='y'? Wy[e]= e: "";
        });
        b.map((v, e) =>{
          v=='x'? Wx[e]= e: "";
        });
        _Draw();
      });
      const _Draw= () =>{
        ctx.beginPath();//start;
        let cx="";//식
        b.map(e=>{cx+=e});//식들 값을 배열에 넣어둔거
        for ( var i = -4; i <= 4; i = i+0.01 ) {//-4~4 line draw
          _Line(Wx, b, i , true);//move
          _Line(Wx, b, i+0.01 , false);//line
        }
        ctx.closePath();//end
      }
      const _InsetX= (WX,B,i) =>{
        WX.map((v,e) =>{//Wx에 넣어둔 x위치에 i값을 넣어줌
          if( !isNaN( Number( B[WX[e] - 1] ) ) )
          B[WX[e]]="*"+i;//넣어줌
          else
          B[WX[e]]='('+i+')';//넣어줌
        });
      };
      const _Line= (WX, B, i, tf) =>{
        let onbracket= false;
        bracket="";
        _InsetX(WX,B,i);
        let Lb=B.slice();
        Lb.map((v, n) =>{
          switch (Lb[n]) {
            case '(':
              while(Lb[n]!=')'){
                if(Lb[n]=='^')
                  bracket+='**';
                else
                  bracket+=Lb[n];
                n++;
              }
              bracket+=Lb[n];
              n++;
              break;
            case '^':
              let sq="";
              for(var i=0;i<Lb[n+1]-1;i++){
                sq+= "*"+Lb[n-1];
              }
              Lb[n]=sq;
              Lb[n+1]="";
              break;
            default:
          }
        });
        evr="";
        m=undefined;
        for(var j=0;j<Lb.length;j++){//evr에 넣어줌
          if(onbracket){
            if(Lb[j]==')')
              onbracket= false;
          }else{
            if(m!=undefined){//j-1 == "-"
                if(Lb[j]!='('){
                  if(Lb[j-1]!=undefined)
                    evr+= "-"+Lb[j];
                  else
                    evr+= "-"+Lb[j];
                }else if(Lb[j+1]=='^'){
                  evr+='('+Lb[j];
                  j++;
                  for(var p=1;p<Lb[j+1];p++){
                    evr+= "*"+Lb[j-1];
                  }
                  evr+=')';
                  j++;
                }
                else if(Lb[j]=='('){
                    onbracket= true;
                    evr+= "(-1)*"+bracket;
                }else{
                  if(Lb[j-1]!=undefined)
                    evr+= "-"+B[j];
                  else
                    evr+= "-"+B[j];
                }
                m= undefined;
            }else{
              if(Lb[j]=='-'){// j == "-"
                if(m==undefined){// m값이 없으면 m == j
                  m= j;
                }
              }else if(Lb[j+1]=='^'){
                evr+='('+Lb[j];
                j++;
                for(var p=1;p<Lb[j+1];p++){
                  evr+= "*"+Lb[j-1];
                }
                evr+=')';
                j++;
              }else{// j != "-"
                if(Lb[j]=='('){
                  onbracket= true;
                  evr+= bracket;
                }else{
                  evr+= Lb[j];
                }
              }
            }
          }
        }
        let xl= ((i * 100) + 400).toFixed(2);//x location
        let yl= ((-(eval(evr)*100)) + 400).toFixed(2);//y location
        if( 810 >= yl && yl >= -10)//in canvas
          tf? ctx.moveTo(xl, yl): (ctx.lineTo(xl, yl),ctx.stroke());

        //console log
        if(String((xl-400)/100).length - String((xl-400)/100).indexOf('.') -1 == 1 && tf)
          console.log(`    ${(xl-400)/100},${(-(yl)+400)/100}`);
      }
      let press = false; //누르고있는지
      let dx;
      let dy; //첫클릭, 이전위치
      let mx;
      let my; //현재위치
      where = document.getElementById("where"); //위치표시박스
      const _Where = (e) => { //위치표시박스에 위치넣어줌
        where.style.left = (e.pageX + 30) + "px";
        where.style.top = (e.pageY - 30) + "px";
        where.innerText = `(${dx-canvas.width/2}, ${canvas.height/2-dy})`;
      }
      const getW = (e, w) => { //get x,y
        return w ? (e.pageX - parseInt(canvas.style.left, 10)) : (e.pageY - parseInt(canvas.style.top, 10));
      }
      canvas.addEventListener("mousedown", (e) => {
        ctx.beginPath();
        dx = getW(e, true); //getx
        dy = getW(e, false); //gety
        press = true; //누르는중
        ctx.moveTo(dx, dy);
        ctx.lineTo(dx, dy);
        ctx.stroke();
        _Where(e); //위치표시
      });
      window.addEventListener("mousemove", (e) => {
        if (press) {
          mx = getW(e, true);
          my = getW(e, false);
          ctx.moveTo(dx, dy);
          ctx.lineTo(mx, my);
          ctx.stroke();
          dx = mx;
          dy = my;
          e.target.id == 'canvas' ?
            _Where(e) :
            where.innerText = "";
        }
      });
      window.addEventListener("mouseup", (e) => {
        press = false;
        where.innerText = "";
        ctx.closePath();
      });
    }
  </script>
  <title>Where</title>
</head>
<body>
  <input id="range" type="range" name="" value="">
  <canvas id="canvas" width="800" height="800">turn on js</canvas>
  <form id="get_f" action="" method="">
    <input id="Function" type="text" placeholder="y=x^2" autofocus/>
    <button type="submit">입력</button>
    <br>
    <div id="Color_box">

    </div>
    setColor
  </form>
  <span id="where"></span>
  <div id="Color_set">
    <canvas id="Choice_color" width="255" height="25">
    </canvas>
    <canvas id="Choice_bw" width="255" height="255">
    </canvas>
  </div>
</body>

</html>
